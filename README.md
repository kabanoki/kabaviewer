# KabaViewer 🖼️

PyQt5で作成されたシンプルで高機能な画像ビューアアプリケーションです。  
シングル表示と4分割グリッド表示、スライドショー機能、お気に入り・履歴管理を備えた  
**Mac用ネイティブアプリケーション**として動作します。

## 特徴

- 🖼️ 様々な画像形式をサポート（PNG, JPG, JPEG, GIF, BMPなど）
- 📱 シングル表示・4分割グリッド表示の切り替え
- ⭐ お気に入り機能でフォルダを管理
- 📝 閲覧履歴の記録と参照
- 🎬 スライドショー機能（1-10秒の速度調整可能）
- 🔀 複数の並び順（ランダム、日付順、名前順）
- 📊 画像メタデータ表示機能（EXIF情報・AI生成画像のプロンプト等）
- 🏷️ スマートタグ管理システム（検索・分類・ポータブル）
- 🔍 **高度タグ検索**（包含検索・除外検索・お気に入りフィルター）
- 🎨 視覚的タグ管理（色分け表示・直感的操作）
- 📦 **ZIP圧縮ダウンロード**（フィルタされたリストを簡単バックアップ）
- ⌨️ 豊富なキーボードショートカット
- 🎯 直感的で使いやすいユーザーインターフェース
- 🍎 Mac用ネイティブアプリケーション対応
- 🚀 メモリ最適化設計（長時間スライドショーでも安定動作）

## システム要件

### 開発環境での実行
- Python 3.7以上（推奨: Python 3.12）
- PyQt5
- PIL (Pillow)
- PyInstaller（ビルド時のみ）

### Mac用アプリケーション
- macOS 10.14以上
- 約100MBのディスク容量

## インストール

### 1. リポジトリをクローン

```bash
git clone <repository-url>
cd kabaviewer
```

### 2. 仮想環境の作成と有効化

```bash
python -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate     # Windows
```

### 3. 依存関係のインストール

```bash
pip install PyQt5 Pillow
# タグ管理・自動解析機能の追加依存関係
pip install concurrent.futures  # 通常は標準ライブラリに含まれます
```

**必要なライブラリ**:
- **PyQt5**: GUI フレームワーク
- **Pillow (PIL)**: 画像処理・メタデータ読み取り
- **concurrent.futures**: マルチスレッド処理
- **multiprocessing**: 並列処理（標準ライブラリ）
- **threading**: スレッド管理（標準ライブラリ）

## 使用方法

### Mac用アプリケーション（推奨）

1. `dist/KabaViewer.app`をダブルクリックして起動
2. フォルダを選択して画像を閲覧開始

### 開発環境での実行

```bash
# 仮想環境を有効化
source venv/bin/activate

# アプリケーション実行
python main.py
```

### キーボードショートカット

- `←` / `→` : 前の画像 / 次の画像
- `G` または `Tab` : シングル表示 ⇔ 4分割表示の切り替え
- `R` : 4分割表示でグリッド再シャッフル
- `E` : 画像メタデータ情報表示（EXIF・AI生成画像のプロンプト等）
- `S` : サイドバー表示/非表示切り替え
- `T` : タグ編集ダイアログ表示
- `A` : プロンプト解析による自動タグ付け
- `Delete` : 画像削除（確認ダイアログ付き）
- マウスクリック : スライドショー開始/停止
- 右クリック : コンテキストメニュー表示

### Mac用アプリのビルド

```bash
# 依存関係のインストール
pip install pyinstaller

# Mac用.appファイルのビルド
pyinstaller --clean --noconfirm KabaViewer.spec
```

## ファイル構成

```
kabaviewer/
├── main.py               # メインアプリケーション
├── image_viewer.py       # 画像表示機能（シングル・4分割表示）
├── favorite.py           # お気に入り機能
├── history.py            # 履歴機能
├── tag_manager.py        # タグ管理システム（3層アーキテクチャ）
├── tag_ui.py             # タグUI・検索インターフェース
├── auto_tag_analyzer.py  # AI画像プロンプト解析・自動タグ付け
├── logo.png              # アプリケーションロゴ・アイコン
├── KabaViewer.spec       # PyInstallerビルド設定（Mac用.app）
├── main.spec             # PyInstallerビルド設定（汎用）
├── venv/                 # Python仮想環境
├── build/                # ビルド中間ファイル
├── dist/                 # ビルド成果物
│   ├── KabaViewer/       # 実行可能ファイル（フォルダ形式）
│   └── KabaViewer.app    # Mac用アプリケーション（93MB）
└── __pycache__/          # Python キャッシュファイル
```

### 主要コンポーネント

- **main.py**: アプリケーションのエントリーポイント
- **image_viewer.py**: 画像表示、スライドショー、4分割表示のメイン処理
- **favorite.py**: お気に入りフォルダ管理とプレビュー機能
- **history.py**: 閲覧履歴管理と存在チェック機能
- **tag_manager.py**: 3層アーキテクチャによるタグ管理システム（コア機能）
- **tag_ui.py**: タグ編集・検索・フィルタリングのユーザーインターフェース
- **auto_tag_analyzer.py**: AI画像プロンプト解析・自動タグ付けエンジン

## 機能

### 画像表示
- **シングル表示**: 1枚の画像を高品質表示
- **4分割グリッド表示**: 4つの独立したランダムグリッドで同時表示
- **スライドショー**: 1-10秒の間隔で自動再生
- 画像間の簡単なナビゲーション（キーボード・マウス対応）

### 表示モード切り替え
- `G`キーまたは`Tab`キーでシングル⇔4分割表示を瞬時切り替え
- 4分割表示では各グリッドが独立したランダム順序
- `R`キーで4分割グリッドの再シャッフル

### 並び順機能
- **ランダム**: 毎回異なる順序で表示
- **日付順**: 変更日、追加日、作成日での昇順・降順
- **名前順**: ファイル名での昇順・降順

### お気に入り管理
- フォルダをお気に入りに追加/削除
- お気に入り一覧の表示と管理
- プレビュー機能付き

### 閲覧履歴
- 最近閲覧したフォルダの自動記録
- 履歴からの素早いアクセス
- 存在しないフォルダの自動クリーンアップ

### 画像メタデータ表示
- **詳細な撮影情報**: カメラ機種、撮影設定、日時等のEXIF情報を表示
- **AI生成画像対応**: Stable Diffusionのプロンプト、設定値、モデル情報等を表示
- **GPS情報**: 位置情報が含まれている場合は座標を表示
- **包括的メタデータ**: PNG chunks、JPEG comments等も読み取り
- **サイドバー表示**: 画像を見ながら常時メタデータを確認可能
- **テキスト選択・コピー**: プロンプト等のテキストを選択・コピー可能
- **キーボードショートカット**: `E`キーでダイアログ表示、`S`キーでサイドバー切り替え
- **設定保存**: サイドバーの表示/非表示状態を記憶

### プロンプト解析による自動タグ付け

AI生成画像のプロンプト（メタデータ）を解析して、自動でタグを生成・付与する機能です。

**主な特徴**:
- **高精度な分析**: Stable Diffusion、Midjourney等のプロンプトを解析
- **日本語タグ生成**: 英語キーワードを日本語タグに自動翻訳
- **カテゴリ分類**: 人物、背景、スタイル、品質等を自動分類
- **カスタムルール**: 独自のキーワード→タグマッピング設定可能
- **一括処理**: 複数画像を同時に処理、進捗表示付き
- **プレビュー機能**: 適用前に提案タグを確認・選択可能

**使用方法**:
1. 画像フォルダを開いてビューアーで表示
2. `A`キーまたは右クリック→「プロンプト解析で自動タグ付け」
3. 解析開始を押して全画像のプロンプトを解析
4. 提案されたタグをプレビューで確認・選択
5. 選択したタグを一括適用

**自動認識するキーワード例**:
- 人物: `1girl`, `boy`, `woman` → 「人物」「キャラクター」
- 表情: `smile`, `happy`, `sad` → 「表情」「幸せ」「悲しい」
- 衣装: `dress`, `uniform`, `kimono` → 「衣装」「制服」「和装」
- 背景: `outdoor`, `school`, `nature` → 「屋外」「学校」「自然」
- 品質: `masterpiece`, `best_quality` → 「高品質」「傑作」

### スマートタグ管理システム

高度なタグ管理機能で画像コレクションを効率的に整理・検索できます。

**主な特徴**:
- **3層アーキテクチャ**: 高速検索・ポータブル設計・自動バックアップ機能
- **EXIF埋め込み**: 画像ファイル自体にタグ情報を保存（ポータブル性確保）
- **高速検索**: タグベースの瞬時フィルタリング・検索機能
- **除外タグ検索**: 特定のタグを持つ画像を検索結果から除外
- **お気に入りフィルター**: お気に入り登録された画像のみを表示
- **オートコンプリート**: 既存タグの自動補完・人気タグ提案
- **バッチ操作**: 複数画像への一括タグ付け機能
- **タグ管理**: 専用タブでのタグ統計・管理・削除機能
- **視覚的フィードバック**: 選択されたタグの色分け表示（検索タグ：青色、除外タグ：赤色）

**使用方法**:
1. `T`キーまたは右クリック→「タグ編集」
2. タグを入力（カンマ区切りで複数可能）
3. 検索バーで「tag:風景」「tag:人物,キャラクター」形式でフィルタリング
4. **除外タグ機能**: 除外したいタグを除外タグ欄に入力、または**Ctrl+クリック**でタグを除外に追加
5. **お気に入りフィルター**: 「♡ お気に入りのみ」チェックボックスで絞り込み
6. **クリアボタン**: 「×」ボタンで検索・除外タグを個別にクリア
7. タグ管理タブで全タグの統計・管理

**検索機能の詳細**:
- **包含検索**: 指定したタグを含む画像を表示
- **除外検索**: 指定したタグを含む画像を結果から除外（例：「風景」で検索しつつ「夜景」を除外）
- **お気に入り絞り込み**: お気に入りに登録された画像のみに結果を限定
- **複合検索**: 包含タグ＋除外タグ＋お気に入りフィルターの組み合わせ検索
- **タグクリック操作**:
  - **通常クリック**: タグを検索に追加
  - **Ctrl+クリック**: タグを除外に追加
- **視覚的表示**: 選択中のタグが色分けされて表示（検索タグ：青、除外タグ：赤）

### ZIP圧縮ダウンロード機能

現在表示中の画像リストをZIPファイルに圧縮してダウンロードできる便利な機能です。

**主な特徴**:
- **元画像保持**: 元のフォルダの画像はそのままで、コピーしてZIP化
- **フィルタ対応**: タグフィルタ、お気に入りフィルタされたリストも圧縮可能
- **スマートファイル名**: タイムスタンプと内容に応じた自動命名
- **プログレス表示**: 圧縮進行状況をリアルタイム表示
- **エラーハンドリング**: ファイル名重複の自動解決、存在しないファイルのスキップ
- **キャンセル機能**: 圧縮中のキャンセルと途中ファイルのクリーンアップ

**使用方法**:
1. フォルダを開くか、タグでフィルタリングして画像リストを表示
2. 「ファイル」メニュー → 「📦 リストをZIP圧縮」を選択
3. 保存先とファイル名を指定
4. 圧縮進行状況を確認
5. 完了報告で成功・スキップファイル数を確認

**ファイル名例**:
- フォルダモード: `images_from_MyFolder_20231011_143025.zip`
- タグフィルタ: `filtered_images_風景_20231011_143025.zip`
- お気に入り: `filtered_images_お気に入りのみ_20231011_143025.zip`

### その他の機能
- **画像削除機能**: 確認ダイアログ付き（デフォルト選択：Yes）
- **リッチなコンテキストメニュー**: 右クリックで全機能にアクセス
- **タブ形式インターフェース**: 画像表示・お気に入り・履歴・タグ管理
- **設定の自動保存**: ウィンドウサイズ・位置・サイドバー状態を記憶
- **マルチフォーマット対応**: PNG, JPG, JPEG, GIF, BMP, WebP等

## 開発

### 開発環境のセットアップ

```bash
# 開発用依存関係のインストール
pip install PyQt5 Pillow pyinstaller

# オプション: 高度な画像処理機能（必要な場合）
pip install numpy opencv-python
```

### ビルド

```bash
# Mac用アプリのビルド（推奨）
pyinstaller --clean --noconfirm KabaViewer.spec

# 開発版ビルド（基本）
pyinstaller --onefile main.py
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

プルリクエストやイシューの報告を歓迎します。

## 作者

開発者: KABANOKI

---

## 更新履歴

- v1.7.0: メモリ管理とパフォーマンスの大幅改善
  - **🚀 メモリ最適化**: 長時間スライドショー実行時のメモリリーク防止
  - **📊 リソース管理改善**: 画像ファイルハンドルの適切なクローズ処理
  - **🔧 QImageメモリ安全性向上**: バイト配列の明示的な保持とコピー生成
  - **⚡ サイドバー最適化**: 非表示時のメタデータ解析スキップによるCPU負荷削減
  - **🎯 UI構築最適化**: ExifInfoDialog解析ロジックの分離（不要なウィジェット生成の抑制）
  - withコンテキストマネージャによる確実なリソース解放
  - ガベージコレクションの効率化とメモリ使用量の安定化
  - 全ての画像読み込み処理（メイン表示、グリッド表示、履歴プレビュー、タグプレビュー）でメモリ管理を改善

- v1.6.0: ZIP圧縮ダウンロード機能追加
  - **📦 リストZIP圧縮**: 現在表示中の画像リストをZIPファイルに圧縮してダウンロード
  - **フィルタ対応**: タグフィルタ、お気に入りフィルタされたリストも圧縮可能
  - **スマート命名**: タイムスタンプと内容に応じた自動ファイル名生成
  - **プログレス表示**: 圧縮進行状況のリアルタイム表示とキャンセル機能
  - **堅牢性**: エラーハンドリング、ファイル名重複解決、途中キャンセル時のクリーンアップ
  - **元画像保持**: 圧縮は元画像のコピーで行い、オリジナルファイルはそのまま保持
  - ファイルメニューからの簡単アクセスと詳細な完了レポート

- v1.5.0: 高度タグ検索機能とユーザビリティ大幅向上
  - **🔍 除外タグ検索機能**: 特定のタグを持つ画像を検索結果から除外
  - **♡ お気に入りフィルター**: お気に入り登録された画像のみを表示する絞り込み機能
  - **🎨 視覚的タグ管理**: 選択中のタグを色分け表示（検索タグ：青色、除外タグ：赤色）
  - **⚡ 直感的操作**: 通常クリックで検索追加、Ctrl+クリックで除外追加
  - **❌ クリアボタン**: 検索・除外タグを個別にクリアできる×ボタン追加
  - **🔄 複合検索**: 包含検索＋除外検索＋お気に入りフィルターの組み合わせ
  - **📊 リアルタイム更新**: 入力内容に応じてタグの色表示がリアルタイムで更新
  - TagManagerクラスのsearch_by_tags機能拡張とUI大幅改善

- v1.4.0: UI改善とユーザビリティ向上
  - **削除確認ダイアログの改善**: デフォルト選択をYesに変更（効率的な削除操作）
  - **ハートアイコン位置調整**: お気に入り表示カードの位置微調整
  - **コードベース最適化**: メンテナンス性の向上と処理速度改善
  - 各種バグ修正と安定性向上

- v1.3.0: スマートタグ管理システム追加
  - 3層アーキテクチャによる高速検索・ポータブル・バックアップ機能
  - 画像タグの追加・編集・削除機能（EXIF埋め込み対応）
  - タグベースの高度検索・フィルタリング機能
  - オートコンプリート・人気タグ提案機能
  - **🤖 AI画像プロンプト解析による自動タグ付け機能**
  - Tキーでタグ編集、Aキーで自動タグ付け、右クリックメニュー統合
  - 専用タグ管理タブの追加

- v1.2.0: サイドバー機能とUI改善
  - メタデータサイドバー表示機能（画像と並行してメタデータを常時確認）
  - サイドバーの表示/非表示設定の保存機能
  - テキスト選択・コピー機能（プロンプト等を自由に選択・コピー）
  - サイドバー幅の最適化（より多くの情報を表示）
  - Sキーによるサイドバー切り替え機能
  - ウィンドウサイズ・位置の自動保存機能（次回起動時に復元）

- v1.1.0: 画像メタデータ表示機能追加
  - 画像メタデータ表示機能（EXIF情報・AI生成画像のプロンプト等）
  - Stable Diffusionなどの生成AIプロンプト読み取り対応
  - PNG chunks、JPEG comments等の包括的メタデータ読み取り
  - Eキーによる素早いメタデータ情報アクセス
  - メニューバー・コンテキストメニューからのアクセス
  - 分類別の読みやすい形式での情報表示

- v1.0.0: 初回リリース
  - 基本的な画像表示機能（シングル・4分割グリッド表示）
  - スライドショー機能（1-10秒の速度調整）
  - お気に入り機能（フォルダ管理・プレビュー付き）
  - 履歴機能（自動記録・クリーンアップ）
  - 豊富なキーボードショートカット
  - 複数の並び順オプション
  - Mac用ネイティブアプリケーション
  - 画像削除機能
  - タブ形式UI